{"version":3,"sources":["../../../src/utils/webpack/dev.js"],"names":["isInteractive","process","stdout","isTTY","DEFAULT_PORT","parseInt","env","PORT","HOST","PROTOCOL","HTTPS","CERT","fs","readFileSync","KEY","noop","NODE_ENV","dev","webpackConfig","_beforeServerWithApp","beforeMiddlewares","afterMiddlewares","beforeServer","afterServer","contentBase","onCompileDone","proxy","port","base","serverConfig","serverConfigFromOpts","then","compiler","isFirstCompile","IS_CI","CI","SILENT","urls","hooks","done","tap","stats","hasErrors","SYSTEM_BELL","write","console","log","chalk","cyan","localUrlForTerminal","lanUrlForTerminal","join","localUrlForBrowser","DONE","disableHostCheck","compress","clientLogLevel","hot","quiet","headers","publicPath","output","watchOptions","ignored","historyApiFallback","overlay","host","https","cert","key","CONTENT_BASE","before","app","forEach","middleware","use","after","devServer","server","WebpackDevServer","signal","on","close","exit","listen","err","STARTING"],"mappings":"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","sourcesContent":["import fs from 'fs';\nimport openBrowser from 'react-dev-utils/openBrowser';\nimport webpack from 'webpack';\nimport assert from 'assert';\nimport WebpackDevServer from 'webpack-dev-server';\nimport chalk from 'chalk';\nimport prepareUrls from './prepareUrls';\nimport clearConsole from '../common/clearConsole';\nimport errorOverlayMiddleware from './errorOverlayMiddleware';\nimport send, { STARTING, DONE } from './send';\nimport choosePort from './choosePort';\n\nconst isInteractive = process.stdout.isTTY; //nodejs否在 TTY 上下文中运行\nconst DEFAULT_PORT = parseInt(process.env.PORT, 10) || 8000;\nconst HOST = process.env.HOST || '0.0.0.0';\nconst PROTOCOL = process.env.HTTPS ? 'https' : 'http';\nconst CERT = process.env.HTTPS && process.env.CERT ? fs.readFileSync(process.env.CERT) : '';\nconst KEY = process.env.HTTPS && process.env.KEY ? fs.readFileSync(process.env.KEY) : '';\nconst noop = () => {};\n\nprocess.env.NODE_ENV = 'development';\n\nexport default function dev({\n  webpackConfig,\n  _beforeServerWithApp,\n  beforeMiddlewares,\n  afterMiddlewares,\n  beforeServer,\n  afterServer,\n  contentBase,\n  onCompileDone = noop,\n  proxy,\n  port,\n  base,\n  serverConfig: serverConfigFromOpts = {},\n}) {\n  assert(webpackConfig, 'webpackConfig must be supplied');\n  choosePort(port || DEFAULT_PORT)\n    .then(port => {\n      if (port === null) {\n        return;\n      }\n\n      const compiler = webpack(webpackConfig);\n\n      let isFirstCompile = true;\n      const IS_CI = !!process.env.CI;\n      const SILENT = !!process.env.SILENT;\n      const urls = prepareUrls(PROTOCOL, HOST, port, base);\n      compiler.hooks.done.tap('zus dev', stats => {\n        if (stats.hasErrors()) {\n          if (process.env.SYSTEM_BELL !== 'none') {\n            process.stdout.write('\\x07'); // 蜂鸣响铃\n          }\n          return;\n        }\n\n        if (isFirstCompile && !IS_CI && !SILENT) {\n          console.log();\n          console.log(\n            [\n              `  App running at:`,\n              `  - Local:   ${chalk.cyan(urls.localUrlForTerminal)}`,\n              `  - Network: ${chalk.cyan(urls.lanUrlForTerminal)}`,\n            ].join('\\n'),\n          );\n          console.log();\n        }\n\n        onCompileDone({\n          isFirstCompile,\n          stats,\n        });\n\n        if (isFirstCompile) {\n          isFirstCompile = false;\n          openBrowser(urls.localUrlForBrowser);\n          send({ 'zus:server': DONE });\n        }\n      });\n\n      const serverConfig = {\n        disableHostCheck: true,\n        compress: true,\n        clientLogLevel: 'none',\n        hot: true,\n        quiet: true,\n        headers: {\n          'access-control-allow-origin': '*',\n        },\n        publicPath: webpackConfig.output.publicPath,\n        watchOptions: {\n          ignored: /node_modules/,\n        },\n        historyApiFallback: true,\n        overlay: false,\n        host: HOST,\n        proxy,\n        https: !!process.env.HTTPS,\n        cert: CERT,\n        key: KEY,\n        contentBase: contentBase || process.env.CONTENT_BASE,\n        before(app) {\n          (beforeMiddlewares || []).forEach(middleware => {\n            app.use(middleware);\n          });\n          // internal usage for proxy\n          if (_beforeServerWithApp) {\n            _beforeServerWithApp(app);\n          }\n          app.use(errorOverlayMiddleware());\n        },\n        after(app) {\n          (afterMiddlewares || []).forEach(middleware => {\n            app.use(middleware);\n          });\n        },\n        ...serverConfigFromOpts,\n        ...(webpackConfig.devServer || {}),\n      };\n      const server = new WebpackDevServer(compiler, serverConfig);\n\n      ['SIGINT', 'SIGTERM'].forEach(signal => {\n        process.on(signal, () => {\n          server.close(() => {\n            process.exit(0);\n          });\n        });\n      });\n\n      if (beforeServer) {\n        beforeServer(server);\n      }\n\n      server.listen(port, HOST, err => {\n        if (err) {\n          console.log(err);\n          return;\n        }\n        if (isInteractive) {\n          clearConsole();\n        }\n        send({ 'zus:server': STARTING });\n        if (afterServer) {\n          afterServer(server, port);\n        }\n      });\n    })\n    .catch(err => {\n      console.log(err);\n    });\n}\n"],"file":"dev.js"}