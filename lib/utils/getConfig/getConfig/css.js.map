{"version":3,"sources":["../../../../src/utils/getConfig/getConfig/css.js"],"names":["DEFAULT_BROWSERS","webpackConfig","opts","isDev","process","env","NODE_ENV","cssOpts","importLoaders","sourceMap","disableCSSSourceMap","cssLoaderOptions","theme","postcssOptions","ident","plugins","require","overrideBrowserslist","browserslist","flexbox","autoprefixer","extraPostCSSPlugins","CSS_COMPRESS","COMPRESS","NO_COMPRESS","preset","cssnano","mergeRules","normalizeUrl","cssModulesConfig","modules","localIdentName","lessOptions","modifyVars","javascriptEnabled","lessLoaderOptions","hasSassLoader","resolve","e","applyCSSRules","rule","cssModules","less","sass","use","loader","options","publicPath","cssPublicPath","hmr","cssModulesExcludes","forEach","exclude","index","config","module","test","filePath","RegExp","indexOf","ext","toLowerCase","cssModulesWithAffix","cssExclude","add","end","disableCSSModules","include","hash","plugin","filename","chunkFilename"],"mappings":"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","sourcesContent":["import { extname } from 'path';\nimport autoprefixer from 'autoprefixer';\nimport normalizeTheme from './normalizeTheme';\n\nconst DEFAULT_BROWSERS = [\n  '>1%',\n  'last 4 versions',\n  'Firefox ESR',\n  'not ie < 9', // React doesn't support IE8 anyway\n];\n\nexport default function(webpackConfig, opts) {\n  const isDev = process.env.NODE_ENV === 'development';\n  const cssOpts = {\n    importLoaders: 1,\n    sourceMap: !opts.disableCSSSourceMap,\n    ...(opts.cssLoaderOptions || {}),\n  };\n  // should pass down opts.cwd\n  const theme = normalizeTheme(opts.theme, opts);\n  const postcssOptions = {\n    // Necessary for external CSS imports to work\n    // https://github.com/facebookincubator/create-react-app/issues/2677\n    ident: 'postcss',\n    plugins: () => [\n      require('postcss-flexbugs-fixes'), // eslint-disable-line\n      autoprefixer({\n        overrideBrowserslist: opts.browserslist || DEFAULT_BROWSERS,\n        flexbox: 'no-2009',\n        ...(opts.autoprefixer || {}),\n      }),\n      ...(opts.extraPostCSSPlugins ? opts.extraPostCSSPlugins : []),\n      ...(isDev\n      || process.env.CSS_COMPRESS === 'none'\n      || process.env.COMPRESS === 'none'\n      || process.env.NO_COMPRESS\n        ? []\n        : [\n            // eslint-disable-next-line global-require\n            require('cssnano')({\n              preset: [\n                'default',\n                opts.cssnano || {\n                  mergeRules: false,\n                  // ref: https://github.com/umijs/umi/issues/955\n                  normalizeUrl: false,\n                },\n              ],\n            }),\n          ]),\n    ],\n  };\n  const cssModulesConfig = {\n    modules: true,\n    localIdentName:\n      cssOpts.localIdentName || (isDev ? '[path][name]__[local]' : '[local]___[hash:base64:5]'),\n  };\n  const lessOptions = {\n    modifyVars: theme,\n    javascriptEnabled: true,\n    ...(opts.lessLoaderOptions || {}),\n  };\n\n  let hasSassLoader = true;\n  try {\n    require.resolve('sass-loader');\n  } catch (e) {\n    hasSassLoader = false;\n  }\n\n  function applyCSSRules(rule, { cssModules, less, sass }) {\n    rule\n      .use('extract-css-loader')\n      // eslint-disable-next-line global-require\n      .loader(require('mini-css-extract-plugin').loader)\n      .options({\n        publicPath: isDev ? '/' : opts.cssPublicPath,\n        hmr: isDev,\n      });\n\n    rule\n      .use('css-loader')\n      .loader(require.resolve('css-loader'))\n      .options({\n        ...cssOpts,\n        ...(cssModules ? cssModulesConfig : {}),\n      });\n\n    rule\n      .use('postcss-loader')\n      .loader(require.resolve('postcss-loader'))\n      .options(postcssOptions);\n\n    if (less) {\n      rule\n        .use('less-loader')\n        .loader(require.resolve('less-loader'))\n        .options(lessOptions);\n    }\n\n    if (sass && hasSassLoader) {\n      rule\n        .use('sass-loader')\n        .loader(require.resolve('sass-loader'))\n        .options(opts.sass);\n    }\n  }\n\n  if (opts.cssModulesExcludes) {\n    opts.cssModulesExcludes.forEach((exclude, index) => {\n      const rule = `cssModulesExcludes_${index}`;\n      const config = webpackConfig.module.rule(rule).test(filePath => {\n        if (exclude instanceof RegExp) {\n          return exclude.test(filePath);\n        } else {\n          return filePath.indexOf(exclude) > -1;\n        }\n      });\n      const ext = extname(exclude).toLowerCase();\n      applyCSSRules(config, {\n        less: ext === '.less',\n        sass: ext === '.sass' || ext === '.scss',\n      });\n    });\n  }\n\n  if (opts.cssModulesWithAffix) {\n    applyCSSRules(webpackConfig.module.rule('.module.css').test(/\\.module\\.css$/), {\n      cssModules: true,\n    });\n    applyCSSRules(webpackConfig.module.rule('.module.less').test(/\\.module\\.less$/), {\n      cssModules: true,\n      less: true,\n    });\n    applyCSSRules(webpackConfig.module.rule('.module.sass').test(/\\.module\\.(sass|scss)$/), {\n      cssModules: true,\n      sass: true,\n    });\n  }\n\n  function cssExclude(filePath) {\n    if (/node_modules/.test(filePath)) {\n      return true;\n    }\n    if (opts.cssModulesWithAffix) {\n      if (/\\.module\\.(css|less|sass|scss)$/.test(filePath)) return true;\n    }\n    if (opts.cssModulesExcludes) {\n      for (const exclude of opts.cssModulesExcludes) {\n        if (filePath.indexOf(exclude) > -1) return true;\n      }\n    }\n    return false;\n  }\n\n  applyCSSRules(\n    webpackConfig.module\n      .rule('css')\n      .test(/\\.css$/)\n      .exclude.add(cssExclude)\n      .end(),\n    {\n      cssModules: !opts.disableCSSModules,\n    },\n  );\n  applyCSSRules(\n    webpackConfig.module\n      .rule('css-in-node_modules')\n      .test(/\\.css$/)\n      .include.add(/node_modules/)\n      .end(),\n    {},\n  );\n  applyCSSRules(\n    webpackConfig.module\n      .rule('less')\n      .test(/\\.less$/)\n      .exclude.add(cssExclude)\n      .end(),\n    {\n      cssModules: !opts.disableCSSModules,\n      less: true,\n    },\n  );\n  applyCSSRules(\n    webpackConfig.module\n      .rule('less-in-node_modules')\n      .test(/\\.less$/)\n      .include.add(/node_modules/)\n      .end(),\n    {\n      less: true,\n    },\n  );\n  applyCSSRules(\n    webpackConfig.module\n      .rule('sass')\n      .test(/\\.(sass|scss)$/)\n      .exclude.add(cssExclude)\n      .end(),\n    {\n      cssModules: !opts.disableCSSModules,\n      sass: true,\n    },\n  );\n  applyCSSRules(\n    webpackConfig.module\n      .rule('sass-in-node_modules')\n      .test(/\\.(sass|scss)$/)\n      .include.add(/node_modules/)\n      .end(),\n    {\n      sass: true,\n    },\n  );\n\n  const hash = !isDev && opts.hash ? '.[contenthash:8]' : '';\n\n  // eslint-disable-next-line global-require\n  webpackConfig.plugin('extract-css').use(require('mini-css-extract-plugin'), [\n    {\n      filename: `[name]${hash}.css`,\n      chunkFilename: `[name]${hash}.chunk.css`,\n    },\n  ]);\n}\n"],"file":"css.js"}