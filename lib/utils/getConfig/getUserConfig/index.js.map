{"version":3,"sources":["../../../../src/utils/getConfig/getUserConfig/index.js"],"names":["debug","require","plugins","pluginNames","map","p","name","pluginsMapByName","reduce","memo","devServer","USER_CONFIGS","throwError","msg","printError","Error","messages","sockWrite","sockets","reload","restart","why","console","log","chalk","green","close","process","send","type","merge","oldObj","newObj","key","Array","isArray","concat","Object","assign","replaceNpmVariables","value","pkg","replace","version","getUserConfig","opts","cwd","configFile","disabledConfigs","preprocessor","rcFile","jsRCFile","config","JSON","parse","cache","context","errorMsg","keys","forEach","includes","guess","affix","plugin","validate","call","e","message","setConfig","env","NODE_ENV","pkgFile","length","configFailed","watchConfigsAndRun","_devServer","watchOpts","watcher","watchConfigs","on","beforeChange","newConfig","onChange","stringify","bind","val","newVal","error","red","watch","unwatchConfigs"],"mappings":"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","sourcesContent":["import { existsSync, readFileSync } from 'fs';\nimport { resolve } from 'path';\nimport assert from 'assert';\nimport stripJsonComments from 'strip-json-comments';\nimport didyoumean from 'didyoumean';\nimport chalk from 'chalk';\nimport { isPlainObject, isEqual } from 'lodash';\nimport clearConsole from '../../common/clearConsole';\nimport { watch, unwatch } from './watch';\nimport getPlugins from './getPlugins';\n\nconst debug = require('debug')('af-webpack:getUserConfig');\n\nconst plugins = getPlugins();\nconst pluginNames = plugins.map(p => p.name);\nconst pluginsMapByName = plugins.reduce((memo, p) => {\n  memo[p.name] = p;\n  return memo;\n}, {});\n\nlet devServer = null;\nconst USER_CONFIGS = 'USER_CONFIGS';\n\nfunction throwError(msg) {\n  printError(msg);\n  throw new Error(msg);\n}\n\nfunction printError(messages) {\n  if (devServer) {\n    devServer.sockWrite(\n      devServer.sockets,\n      'errors',\n      typeof messages === 'string' ? [messages] : messages,\n    );\n  }\n}\n\nfunction reload() {\n  devServer.sockWrite(devServer.sockets, 'content-changed');\n}\n\nfunction restart(why) {\n  clearConsole();\n  console.log(chalk.green(`Since ${why}, try to restart the server`));\n  unwatch();\n  devServer.close();\n  process.send({ type: 'RESTART' });\n}\n\nfunction merge(oldObj, newObj) {\n  for (const key in newObj) {\n    if (Array.isArray(newObj[key]) && Array.isArray(oldObj[key])) {\n      oldObj[key] = oldObj[key].concat(newObj[key]);\n    } else if (isPlainObject(newObj[key]) && isPlainObject(oldObj[key])) {\n      oldObj[key] = Object.assign(oldObj[key], newObj[key]);\n    } else {\n      oldObj[key] = newObj[key];\n    }\n  }\n}\n\nfunction replaceNpmVariables(value, pkg) {\n  if (typeof value === 'string') {\n    return value\n      .replace('$npm_package_name', pkg.name)\n      .replace('$npm_package_version', pkg.version);\n  } else {\n    return value;\n  }\n}\n\n/**\n * getUserConfig\n * @export\n * @param {*} [opts={cwd,configFile,disabledConfigs,preprocessor}]\n * @returns\n */\nexport default function getUserConfig(opts = {}) {\n  const {\n    cwd = process.cwd(),\n    configFile = '.webpackrc',\n    disabledConfigs = [], // 禁用的配置\n    preprocessor, // 回调\n  } = opts;\n\n  // TODO: 支持数组的形式？\n\n  // Read config from configFile and `${configFile}.js`\n  const rcFile = resolve(cwd, configFile);\n  const jsRCFile = resolve(cwd, `${configFile}.js`);\n\n  assert(\n    !(existsSync(rcFile) && existsSync(jsRCFile)),\n    `${configFile} file and ${configFile}.js file can not exist at the same time.`,\n  );\n\n  let config = {};\n  if (existsSync(rcFile)) {\n    config = JSON.parse(stripJsonComments(readFileSync(rcFile, 'utf-8')));\n  }\n  if (existsSync(jsRCFile)) {\n    // no cache\n    delete require.cache[jsRCFile];\n    config = require(jsRCFile) // eslint-disable-line\n    if (config.default) {\n      config = config.default;\n    }\n  }\n  if (typeof preprocessor === 'function') {\n    config = preprocessor(config);\n  }\n\n  // Context for validate function\n  const context = {\n    cwd,\n  };\n\n  // Validate\n  let errorMsg = null;\n  Object.keys(config).forEach(key => {\n    // 禁用项\n    if (disabledConfigs.includes(key)) {\n      errorMsg = `Configuration item ${key} is disabled, please remove it.`;\n    }\n    // 非法的项\n    if (!pluginNames.includes(key)) {\n      const guess = didyoumean(key, pluginNames);\n      const affix = guess ? `do you meen ${guess} ?` : 'please remove it.';\n      errorMsg = `Configuration item ${key} is not valid, ${affix}`;\n    } else {\n      // run config plugin's validate\n      const plugin = pluginsMapByName[key];\n      if (plugin.validate) {\n        try {\n          plugin.validate.call(context, config[key]);\n        } catch (e) {\n          errorMsg = e.message;\n        }\n      }\n    }\n  });\n\n  // 确保不管校验是否出错，下次 watch 判断时能拿到正确的值\n  if (errorMsg) {\n    if (/* from watch */ opts.setConfig) {\n      opts.setConfig(config);\n    }\n    throwError(errorMsg);\n  }\n\n  // Merge config with current env\n  if (config.env) {\n    if (config.env[process.env.NODE_ENV]) {\n      merge(config, config.env[process.env.NODE_ENV]);\n    }\n    delete config.env;\n  }\n\n  // Replace npm variables\n  const pkgFile = resolve(cwd, 'package.json');\n  if (Object.keys(config).length && existsSync(pkgFile)) {\n    const pkg = JSON.parse(readFileSync(pkgFile, 'utf-8'));\n    config = Object.keys(config).reduce((memo, key) => {\n      memo[key] = replaceNpmVariables(config[key], pkg);\n      return memo;\n    }, {});\n  }\n\n  let configFailed = false;\n  function watchConfigsAndRun(_devServer, watchOpts = {}) {\n    devServer = _devServer;\n\n    const watcher = watchConfigs(opts);\n    if (watcher) {\n      watcher.on('all', () => {\n        try {\n          if (watchOpts.beforeChange) {\n            watchOpts.beforeChange();\n          }\n\n          const { config: newConfig } = getUserConfig({\n            ...opts,\n            setConfig(newConfig) {\n              config = newConfig;\n            },\n          });\n\n          // 从失败中恢复过来，需要 reload 一次\n          if (configFailed) {\n            configFailed = false;\n            reload();\n          }\n\n          // 比较，然后执行 onChange\n          for (const plugin of plugins) {\n            const { name, onChange } = plugin;\n            if (!isEqual(newConfig[name], config[name])) {\n              debug(\n                `Config ${name} changed, from ${JSON.stringify(\n                  config[name],\n                )} to ${JSON.stringify(newConfig[name])}`,\n              );\n(onChange || restart.bind(null, `${name} changed`)).call(null, {\n                name,\n                val: config[name],\n                newVal: newConfig[name],\n                config,\n                newConfig,\n              });\n            }\n          }\n        } catch (e) {\n          configFailed = true;\n          console.error(chalk.red(`Watch handler failed, since ${e.message}`));\n          console.error(e);\n        }\n      });\n    }\n  }\n\n  debug(`UserConfig: ${JSON.stringify(config)}`);\n\n  return { config, watch: watchConfigsAndRun };\n}\n\nexport function watchConfigs(opts = {}) {\n  const { cwd = process.cwd(), configFile = '.webpackrc' } = opts;\n\n  const rcFile = resolve(cwd, configFile);\n  const jsRCFile = resolve(cwd, `${configFile}.js`);\n\n  return watch(USER_CONFIGS, [rcFile, jsRCFile]);\n}\n\nexport function unwatchConfigs() {\n  unwatch(USER_CONFIGS);\n}\n"],"file":"index.js"}